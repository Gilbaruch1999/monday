<template>

  <v-toolbar class="mt-7" :title="toolBarTitle" color="primary">
    <v-checkbox @change="onDetaileGraphChanged()" class="mt-6" v-model="detailedgrpah" label="detailed"></v-checkbox>
    <v-radio-group @change="graphTypeChanged()" v-model="graphType" inline>
      <v-radio class="mt-6" label="BurnDown" value="BurnDown"></v-radio>
      <v-radio class="mt-6" label="BurnUp" value="BurnUp"></v-radio>
      <v-radio class="mt-6" label="Delta" value="Delta"></v-radio>
    </v-radio-group>
  </v-toolbar>
  <div class="mx-4" style="display: flex; justify-content: center">
    <v-row cols="2">
      <v-card class="ma-4" color="primary">
        <v-card-title>Predictability </v-card-title>
        <v-card-text> {{ predictability }} </v-card-text>
      </v-card>
      <v-card class="ma-4" color="primary">
        <v-card-title>Committed </v-card-title>
        <v-card-text>{{ totalPoints }} </v-card-text>
      </v-card>
      <v-card class="ma-4" color="primary">
        <v-card-title>Velocity </v-card-title>
        <v-card-text>{{ totalDonePoints }} </v-card-text>
      </v-card>
    </v-row>
  </div>
  <div v-if="graphType == 'BurnDown'">
    <LineChart :chart-data="graphData" :options="lineChartOptions" />
  </div>
  <div v-if="graphType == 'Delta'">
    <LineChart :chart-data="deltaGraphData" :chart-options="lineChartOptions" />
  </div>
  <div v-if="graphType == 'BurnUp'">
    <LineChart :chart-data="burnUpGraphData" :chart-options="lineChartOptions" />
  </div>
</template>

<script setup lang='ts'>
import { computed, onMounted, ref, type Ref } from "vue";
import { LineChart, useLineChart } from "vue-chart-3";
import { Chart, ChartData, ChartOptions, registerables } from "chart.js";


import ChartDataLabels from 'chartjs-plugin-datalabels';
import { boardItem } from "@/utils/boarditem";
import { addDays, getDaysdiff, isDateInList } from "@/utils/utils";
import { Sprint } from "@/utils/mondayparser";
import { useSprintData } from "../stores/sprintData";

Chart.register(...registerables, ChartDataLabels);

const sprintDataStore = useSprintData();
const idealValues = ref([]);
const actualValues = ref([]);
const burnUpValues = ref([]);
const deltaValues = ref([]);
let dataLabels = ref(["1", '2']);
const idealcolor = "rgb(0,255,0)"
const actualcolor = "rgb(255,165,0)"
const deltacolor = "rgb(255,0,0)"
const burnupcolor = "rgb(0,255,0)"
let predictability = ref("")
let throughPut = ref(0)
let cycleTime = ref(0)
let leadTime = ref(0)
let itemsList: Ref<boardItem[]> = ref([]);
let totalPoints = ref(0)
let totalDonePoints = ref(0)
let detailedgrpah = ref(false)
let detailedList = ref(false)
let graphType = ref("BurnDown")
let getBtnHeader = ref("get API Data")
let curSprint: Ref<Sprint> = ref();
let CurrentBoardType = ref("");
let toolBarTitle = ref("Sprint burndown")
let lineChartText = ref("BurnDown")
let graphData = computed<ChartData<"line">>(() => ({
  labels: dataLabels.value,
  datasets: [
    {
      label: "actual",
      data: actualValues.value,
      backgroundColor: actualcolor,
      borderColor: actualcolor,
      pointStyle: "circle",
      pointRadius: 12,
      pointHoverRadius: 14,
      datalabels: {
        color: 'black',
        labels: {
          title: {
            font: {
              weight: 'bold'
            }
          },
        }
      }
    },
    {
      label: "ideal",
      data: idealValues.value,
      backgroundColor: idealcolor,
      borderColor: idealcolor,
      borderWidth: 2,
      borderDash: [10, 5], // 10px dash, 5px gap
      fill: false,
      pointStyle: "circle",
      pointRadius: 12,
      pointHoverRadius: 14,
      datalabels: {
        color: 'black',
        labels: {
          title: {
            font: {
              weight: 'bold'
            }
          },
        }
      }
    },
  ],
}));


let deltaGraphData = computed<ChartData<"line">>(() => ({
  labels: dataLabels.value,
  datasets: [
    {
      label: "Delta",
      data: deltaValues.value,
      backgroundColor: deltacolor,
      borderColor: deltacolor,
      pointStyle: "circle",
      pointRadius: 12,
      pointHoverRadius: 14,
      datalabels: {
        color: 'black',
        labels: {
          title: {
            font: {
              weight: 'bold'
            }
          },
        }
      }
    },
  ],
}));

let burnUpGraphData = computed<ChartData<"line">>(() => ({
  labels: dataLabels.value,
  datasets: [
    {
      label: "BurnUp",
      data: burnUpValues.value,
      backgroundColor: burnupcolor,
      borderColor: burnupcolor,
      pointStyle: "circle",
      pointRadius: 12,
      pointHoverRadius: 14,
      datalabels: {
        color: 'black',
        labels: {
          title: {
            font: {
              weight: 'bold'
            }
          },
        }
      }
    },
  ],
}));



let lineChartOptions = computed<ChartOptions<"line">>(() => ({
  responsive: true,
  maintainAspectRatio: true,
  plugins: {
    legend: {
    },
    title: {
      display: true,
      text: lineChartText.value,
    },
  },
}));



let { lineChartProps, lineChartRef } = useLineChart({
  chartData: graphData,
  options: lineChartOptions,
});




onMounted(async () => {
  console.log("On mounted burndown ")
  itemsList.value = sprintDataStore.getsprintData()
  curSprint.value = sprintDataStore.getCursprintConfig()
  createGraph()
  toolBarTitle.value = "Sprint " + curSprint.value.name + " burndown"

})



async function createGraph() {

  getBtnHeader.value = "Update data"

  let index = 0;
  for (let i = 1; i < (Math.round(curSprint.value.duration / 7) + 1); i++) {
    for (let j = 1; j < 8; j++) {
      dataLabels.value[index] = i + "." + j
      index++;
    }
  }
  prepareGraph();
  calcBurnUp();

}


function resetData() {
  var currentIndex = getDaysdiff(new Date(), curSprint.value.startDate)
  burnUpValues.value = new Array(currentIndex + 1).fill(0)
  actualValues.value = new Array(currentIndex + 1).fill(0)
  totalPoints.value = 0;
  totalDonePoints.value = 0;
  throughPut.value = 0;
  cycleTime.value = 0;
  leadTime.value = 0;

}


function prepareGraph() {
  resetData()
  if (CurrentBoardType.value == 'Kanban') {
    graphType.value = "Goals";
    detailedList.value = true
  }

  if (detailedgrpah.value) {
    totalPoints.value = itemsList.value.reduce((accumulator, object) => {
      return accumulator + object.subitemsPoints;
    }, 0);

    totalPoints.value += itemsList.value.filter(x => x.subItems.length == 0).reduce((accumulator, object) => {
      return accumulator + object.storyPoints;
    }, 0);


    totalDonePoints.value = itemsList.value.reduce((accumulator, object) => {
      return accumulator + object.subitemsDonePoints;
    }, 0);

  }
  else {
    totalPoints.value = itemsList.value.reduce((accumulator, object) => {
      return accumulator + object.storyPoints;
    }, 0);

    totalDonePoints.value = itemsList.value.reduce((accumulator, object) => {
      return accumulator + object.doneStoryPoints;
    }, 0);
  }

  var curDate = curSprint.value.startDate;
  var step = totalPoints.value / ((curSprint.value.workingDays - 1))
  console.log("Step is " + step)

  for (let index = 0; index < dataLabels.value.length; index++) {
    if (index == 0)
      idealValues.value[index] = totalPoints.value
    else {

      if (isDateInList(curDate, curSprint.value.nonWorkingDays)) {
        idealValues.value[index] = idealValues.value[index - 1]
      }
      else {
        idealValues.value[index] = idealValues.value[index - 1] - step
      }

    }
    curDate = new Date(addDays(curDate, 1))

  }
  for (let index = 0; index < idealValues.value.length; index++) {
    let tmp = Math.round(idealValues.value[index] * 100) / 100
    idealValues.value[index] = Math.round(tmp)



  }
  predictability.value = ((100 * (totalDonePoints.value / totalPoints.value))).toFixed(0) + " %"
  //console.log("End of prepare graph. Total points " + totalPoints.value)


}

function calcBurnUp() {

  var currentIndex = getDaysdiff(new Date(), curSprint.value.startDate)
  if (detailedgrpah.value) {
    var detailedItems = itemsList.value.filter(x => x.subItems.length > 0)
    detailedItems.forEach(element => {
      element.subItems.forEach(subitem => {
        if (subitem.status == "Done") {
          var index = getDaysdiff(subitem.DoneDate, curSprint.value.startDate)
          if ((index >= 0) && (index <= currentIndex)) {
            burnUpValues.value[index] = burnUpValues.value[index] + subitem.storyPoints;
          }
        }
      });
    });
  }
  else {
    var doneitems = itemsList.value.filter(x => x.status == "Done")
    doneitems.forEach(element => {
      var index = getDaysdiff(element.DoneDate, curSprint.value.startDate)
      if ((index >= 0) && (index <= currentIndex))
        burnUpValues.value[index] = burnUpValues.value[index] + element.storyPoints;
    });
  }
  var currentIndex = getDaysdiff(new Date(), curSprint.value.startDate)
  actualValues.value[0] = totalPoints.value
  for (let index = 0; index < actualValues.value.length; index++) {
    actualValues.value[index] = actualValues.value[index] - burnUpValues.value[index]
    if ((index + 1) < actualValues.value.length)
      actualValues.value[index + 1] = actualValues.value[index]
    deltaValues.value[index] = actualValues.value[index] - idealValues.value[index]
  }

}

function onDetaileGraphChanged() {
  prepareGraph();
  calcBurnUp()
}


function graphTypeChanged() {


}


</script>

<style></style>
